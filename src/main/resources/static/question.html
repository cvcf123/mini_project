<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/base.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/layout.css" rel="stylesheet">
    <link href="/css/animations.css" rel="stylesheet">
</head>
<body>
    <nav class="threads-navbar">
        <div class="threads-container">
            <div class="d-flex justify-content-between align-items-center py-3">
                <a href="/" class="threads-btn-secondary">‚Üê Back to Questions</a>
                <div class="d-flex align-items-center gap-2">
                    <div id="theme-toggle-container"></div>
                    <div id="user-actions"></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="threads-container mt-4">
        <div id="question-container"></div>
        <hr>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 id="answers-heading">Answers</h3>
            <button class="threads-btn-ghost btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#allAnswersCollapse" aria-expanded="true" aria-controls="allAnswersCollapse" id="toggleAllAnswersBtn">
                Hide Answers
            </button>
        </div>

        <div class="collapse show" id="allAnswersCollapse">
            <div id="answers-container"></div>

            <div class="threads-card mt-3" id="answer-form-card" style="display: none;">
                <h5 class="threads-title mb-3">Post an Answer</h5>
                <form id="answer-form">
                    <div class="mb-3">
                        <textarea class="threads-textarea" id="answer-content" rows="3" required placeholder="Your answer..."></textarea>
                    </div>
                    <button type="submit" class="threads-btn-primary">Post Answer</button>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/theme-toggle.js"></script>
    <script>
        let currentUser = null;
        let csrfToken = null;

        const userActions = document.getElementById('user-actions');
        const questionContainer = document.getElementById('question-container');
        const answersContainer = document.getElementById('answers-container');
        const answerFormCard = document.getElementById('answer-form-card');
        const answerForm = document.getElementById('answer-form');
        const answerContentInput = document.getElementById('answer-content');
        const toggleAllAnswersBtn = document.getElementById('toggleAllAnswersBtn');

        // Event listener for the main answers collapse button
        const allAnswersCollapseElement = document.getElementById('allAnswersCollapse');
        allAnswersCollapseElement.addEventListener('hide.bs.collapse', function () {
            toggleAllAnswersBtn.textContent = 'Show Answers';
        });
        allAnswersCollapseElement.addEventListener('show.bs.collapse', function () {
            toggleAllAnswersBtn.textContent = 'Hide Answers';
        });

        const formatDate = (dateString) => {
            if (!dateString) return 'Just now';
            const d = new Date(dateString);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        };

        const createAvatar = (username, size = 'md') => {
            const avatar = document.createElement('div');
            avatar.className = `threads-avatar threads-avatar-${size} me-3`;
            avatar.textContent = username ? username.charAt(0).toUpperCase() : '?';
            return avatar;
        }

        const renderComments = async (answerId, commentsContainer) => {
            try {
                const commentsResponse = await fetch(`/comments/answer/${answerId}`);
                if (!commentsResponse.ok) throw new Error('Could not fetch comments');
                const comments = await commentsResponse.json();

                comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.className = 'threads-comment';
                    commentElement.innerHTML = `
                        <div class="threads-line threads-line-subtle"></div>
                        <div class="d-flex align-items-start">
                            ${createAvatar(comment.name, 'sm').outerHTML}
                            <div>
                                <div>
                                    <strong class="threads-author-sm">${comment.name}</strong>
                                    <small class="threads-time ms-2">${formatDate(comment.createdAt)}</small>
                                </div>
                                <p class="threads-comment-content">${comment.content}</p>
                            </div>
                        </div>
                    `;
                    commentsContainer.appendChild(commentElement);
                });
            } catch (e) {
                 commentsContainer.innerHTML = '<small class="text-danger">Could not load comments.</small>';
            }
        };

        const renderAnswers = async (questionId) => {
            try {
                const answersResponse = await fetch(`/answers/question/${questionId}`);
                if (!answersResponse.ok) throw new Error('Could not fetch answers');
                const answers = await answersResponse.json();
                
                document.getElementById('answers-heading').textContent = `Answers (${answers.length})`;

                answersContainer.innerHTML = '';
                if (answers.length === 0) {
                    answersContainer.innerHTML = '<p>No answers yet.</p>';
                    return;
                }
                
                for (const answer of answers) {
                    const answerElement = document.createElement('div');
                    answerElement.className = 'threads-post threads-answer';
                    answerElement.innerHTML = `
                        <div class="threads-line"></div>
                        <div class="d-flex align-items-start">
                            ${createAvatar(answer.userName, 'md').outerHTML}
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <strong class="threads-author">${answer.userName}</strong>
                                    <small class="threads-time ms-2">${formatDate(answer.createdAt)}</small>
                                </div>
                                <div id="answerCollapse${answer.id}">
                                    <p class="threads-content">${answer.content}</p>
                                    <div class="comments-container" id="comments-for-answer-${answer.id}"></div>
                                    ${currentUser ? `
                                    <form class="comment-form mt-2" data-answer-id="${answer.id}">
                                        <div class="input-group">
                                            <input type="text" class="threads-input" placeholder="Add a comment..." required>
                                            <button class="threads-btn-ghost btn-sm" type="submit">Post</button>
                                        </div>
                                    </form>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    answersContainer.appendChild(answerElement);
                    const commentsContainer = document.getElementById(`comments-for-answer-${answer.id}`);
                    await renderComments(answer.id, commentsContainer);
                }
                
                document.querySelectorAll('.comment-form').forEach(form => {
                    form.addEventListener('submit', handleCommentSubmit);
                });
            } catch (error) {
                answersContainer.innerHTML = `<p class="text-danger">${error.message}.</p>`;
            }
        };

        const renderQuestion = async (questionId) => {
             try {
                const questionResponse = await fetch(`/questions/${questionId}`);
                if (!questionResponse.ok) throw new Error('Question not found');
                const question = await questionResponse.json();
                
                questionContainer.innerHTML = `
                    <div class="threads-post threads-question">
                        <div class="d-flex align-items-start">
                            ${createAvatar(question.writerNickname, 'lg').outerHTML}
                            <div class="flex-grow-1">
                                <h2 class="threads-question-title">${question.title}</h2>
                                <div class="mb-2">
                                    <strong class="threads-author">${question.writerNickname}</strong>
                                    <small class="threads-time ms-2">${formatDate(question.createdAt)}</small>
                                </div>
                                <p class="threads-content mt-3">${question.content}</p>
                                <div class="threads-tags mt-3">
                                    ${question.tags.map(tag => `<span class="threads-tag">${tag}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                await renderAnswers(questionId);
            } catch(error) {
                questionContainer.innerHTML = `<p class="text-danger">${error.message}.</p>`;
            }
        }
        
        const handleCommentSubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert('Please login to comment.');
                window.location.href = '/login';
                return;
            }
            const form = e.target;
            const answerId = form.dataset.answerId;
            const content = form.querySelector('input').value;
            const headers = { 
                'Content-Type': 'application/json',
                [csrfToken.headerName]: csrfToken.token
            };

            try {
                const response = await fetch('/comments', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ answerId: Number(answerId), content })
                });
                 if (response.status === 401 || response.status === 403) {
                    alert('You need to be logged in to comment. Redirecting to login page.');
                    window.location.href = '/login';
                    return;
                }
                if (!response.ok) throw new Error('Failed to post comment');
                window.location.reload();
            } catch (error) {
                console.error('Error posting comment:', error);
                alert('Failed to post comment.');
            }
        };

        const handleAnswerSubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert('Please login to answer.');
                window.location.href = '/login';
                return;
            }
            const content = answerContentInput.value;
            const headers = { 
                'Content-Type': 'application/json',
                [csrfToken.headerName]: csrfToken.token
            };

            try {
                const response = await fetch('/answers', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ 
                        questionId: Number(new URLSearchParams(window.location.search).get('id')), 
                        content, 
                        userId: currentUser.id 
                    })
                });
                if (response.status === 401 || response.status === 403) {
                    alert('You need to be logged in to answer. Redirecting to login page.');
                    window.location.href = '/login';
                    return;
                }
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.message || 'Failed to post answer');
                }
                window.location.reload();
            } catch (error) {
                console.error('Error posting answer:', error);
                alert(`Failed to post answer: ${error.message}`);
            }
        };

        const checkLoginStatus = async () => {
            try {
                const response = await fetch('/users/info');
                if (!response.ok) throw new Error('Not logged in');
                currentUser = await response.json();
                
                userActions.innerHTML = `
                    <span class="threads-author me-2">Welcome, ${currentUser.name}</span>
                    <button type="button" class="threads-btn-secondary" id="logout-button">Logout</button>
                `;
                document.getElementById('logout-button').addEventListener('click', () => {
                    const headers = { [csrfToken.headerName]: csrfToken.token };
                    fetch('/logout', { method: 'POST', headers: headers })
                        .then(() => window.location.href = '/login');
                });
                answerFormCard.style.display = 'block';

            } catch (error) {
                currentUser = null;
                userActions.innerHTML = `
                    <a href="/login" class="threads-btn-primary">Login</a>
                    <a href="/register" class="threads-btn-secondary">Register</a>
                `;
                answerFormCard.style.display = 'none';
            }
        };

        const initializeApp = async () => {
            try {
                const csrfResponse = await fetch('/csrf-token');
                csrfToken = await csrfResponse.json();

                await checkLoginStatus();
                
                const urlParams = new URLSearchParams(window.location.search);
                const questionId = urlParams.get('id');

                if (!questionId) {
                    questionContainer.innerHTML = '<p class="text-danger">Question ID is missing.</p>';
                    return;
                }

                await renderQuestion(questionId);
                answerForm.addEventListener('submit', handleAnswerSubmit);

            } catch (error) {
                console.error('Failed to initialize app:', error);
                questionContainer.innerHTML = '<p class="text-danger">Could not initialize app.</p>';
            }
        };

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
