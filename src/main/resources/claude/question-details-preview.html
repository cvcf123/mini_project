<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Question Details (Preview)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#2563eb;
      --primary-2:#1d4ed8;
      --ghost:#111827;
      --ghost-bg:transparent;
      --shadow:0 10px 20px rgba(17,24,39,.08);
      --radius:16px;
    }
    .dark{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:#22304a;
      --primary:#60a5fa;
      --primary-2:#3b82f6;
      --ghost:#e5e7eb;
      --ghost-bg:rgba(229,231,235,.08);
      --shadow:0 10px 20px rgba(0,0,0,.35);
    }
    body{ background:var(--bg); color:var(--text); }
    .threads-container{ max-width: 980px; margin: 0 auto; padding: 0 16px; }
    .threads-navbar{
      position: sticky; top: 0; z-index: 1000;
      background: rgba(246,247,251,.9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--line);
    }
    .dark .threads-navbar{ background: rgba(11,18,32,.85); }
    .threads-btn-secondary,
    .threads-btn-primary,
    .threads-btn-ghost{
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid transparent;
      user-select: none;
      white-space: nowrap;
    }
    .threads-btn-primary{
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow);
    }
    .threads-btn-primary:hover{ background: var(--primary-2); color: white; }
    .threads-btn-secondary{
      background: var(--card);
      color: var(--text);
      border-color: var(--line);
    }
    .threads-btn-secondary:hover{ background: rgba(17,24,39,.03); }
    .dark .threads-btn-secondary:hover{ background: rgba(229,231,235,.06); }
    .threads-btn-ghost{
      background: var(--ghost-bg);
      color: var(--ghost);
      border-color: var(--line);
    }
    .threads-btn-ghost:hover{ background: rgba(17,24,39,.04); }
    .dark .threads-btn-ghost:hover{ background: rgba(229,231,235,.08); }

    .threads-post{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .threads-question{ padding: 22px; }
    .threads-answer{ margin-top: 16px; }
    .threads-line{
      height: 1px;
      background: var(--line);
      margin: 6px 0 16px;
    }
    .threads-line-subtle{
      height: 1px;
      background: var(--line);
      opacity: .7;
      margin: 12px 0;
    }
    .threads-question-title{
      font-size: 1.4rem;
      font-weight: 800;
      line-height: 1.25;
      margin: 0;
    }
    .threads-title{
      font-weight: 800;
      margin: 0;
    }
    .threads-author{ font-weight: 800; }
    .threads-author-sm{ font-weight: 700; font-size: .95rem; }
    .threads-time{ color: var(--muted); font-size: .9rem; }
    .threads-content{ margin: 12px 0 0; color: var(--text); line-height: 1.55; }
    .threads-tags{ display:flex; gap: 8px; flex-wrap: wrap; }
    .threads-tag{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(37,99,235,.06);
      color: var(--text);
      font-weight: 700;
      font-size: .85rem;
    }
    .dark .threads-tag{ background: rgba(96,165,250,.14); }

    .threads-avatar{
      flex: 0 0 auto;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: white;
      background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(147,51,234,.95));
      box-shadow: 0 8px 16px rgba(37,99,235,.18);
    }
    .threads-avatar-lg{ width: 56px; height: 56px; font-size: 1.15rem; }
    .threads-avatar-md{ width: 44px; height: 44px; font-size: 1.05rem; }
    .threads-avatar-sm{ width: 34px; height: 34px; font-size: .95rem; }

    .threads-card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .threads-textarea, .threads-input{
      width: 100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.85);
      padding: 10px 12px;
      outline: none;
      color: var(--text);
    }
    .dark .threads-textarea, .dark .threads-input{
      background: rgba(15,23,42,.65);
    }
    .threads-textarea:focus, .threads-input:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.15);
    }
    .threads-comment{ margin-top: 10px; }
    .threads-comment-content{ margin: 6px 0 0; color: var(--text); }
    .section-title{
      font-size: 1.15rem;
      font-weight: 900;
      margin: 0;
    }
    .pill{
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--muted);
      font-weight: 700;
      font-size: .85rem;
    }
  </style>
</head>
<body>
  <nav class="threads-navbar">
    <div class="threads-container">
      <div class="d-flex justify-content-between align-items-center py-3">
        <a href="#" class="threads-btn-secondary" onclick="return false;">← Back to Questions</a>
        <div class="d-flex align-items-center gap-2">
          <div id="theme-toggle-container"></div>
          <div id="user-actions"></div>
        </div>
      </div>
    </div>
  </nav>

  <div class="threads-container mt-4">
    <div id="question-container"></div>
    <hr class="my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 id="answers-heading" class="section-title">Answers</h3>
      <button class="threads-btn-ghost btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#allAnswersCollapse" aria-expanded="true" aria-controls="allAnswersCollapse" id="toggleAllAnswersBtn">
        Hide Answers
      </button>
    </div>

    <div class="collapse show" id="allAnswersCollapse">
      <div id="answers-container"></div>

      <div class="threads-card mt-3" id="answer-form-card" style="display: none;">
        <h5 class="threads-title mb-3">Post an Answer</h5>
        <form id="answer-form">
          <div class="mb-3">
            <textarea class="threads-textarea" id="answer-content" rows="3" required placeholder="Your answer..."></textarea>
          </div>
          <button type="submit" class="threads-btn-primary">Post Answer</button>
          <span class="pill ms-2">Preview mode (no server)</span>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentUser = null;

    const userActions = document.getElementById('user-actions');
    const questionContainer = document.getElementById('question-container');
    const answersContainer = document.getElementById('answers-container');
    const answerFormCard = document.getElementById('answer-form-card');
    const answerForm = document.getElementById('answer-form');
    const answerContentInput = document.getElementById('answer-content');
    const toggleAllAnswersBtn = document.getElementById('toggleAllAnswersBtn');

    const allAnswersCollapseElement = document.getElementById('allAnswersCollapse');
    allAnswersCollapseElement.addEventListener('hide.bs.collapse', function () {
      toggleAllAnswersBtn.textContent = 'Show Answers';
    });
    allAnswersCollapseElement.addEventListener('show.bs.collapse', function () {
      toggleAllAnswersBtn.textContent = 'Hide Answers';
    });

    const formatDate = (dateString) => {
      if (!dateString) return 'Just now';
      const d = new Date(dateString);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    };

    const createAvatar = (username, size = 'md') => {
      const avatar = document.createElement('div');
      avatar.className = `threads-avatar threads-avatar-${size} me-3`;
      avatar.textContent = username ? username.charAt(0).toUpperCase() : '?';
      return avatar;
    };

    const mock = (() => {
      const now = new Date();
      const iso = (minAgo) => new Date(now.getTime() - minAgo * 60000).toISOString();

      const question = {
        id: 12,
        title: 'How do I implement CSRF protection with fetch()?',
        content: 'I am building a Q&A page. I want to post answers and comments using fetch(), and I need CSRF protection. What is the recommended pattern?',
        writerNickname: 'SeungHyun',
        createdAt: iso(140),
        tags: ['spring-security', 'csrf', 'fetch']
      };

      const answers = [
        { id: 101, userName: 'Alice', createdAt: iso(95), content: 'Expose the CSRF token via an endpoint (or meta tag), then include it in every state-changing request header. Also make sure credentials/cookies are sent.' },
        { id: 102, userName: 'Bob', createdAt: iso(55), content: 'If you use Spring Security, you can return the CSRF token in JSON from /csrf-token. Your client should add it to headers on POST/PUT/DELETE.' }
      ];

      const commentsByAnswer = {
        101: [
          { name: 'SeungHyun', createdAt: iso(80), content: 'Thanks—so I should call /csrf-token once on load?' },
          { name: 'Alice', createdAt: iso(72), content: 'Yes, cache it in memory and refresh on 403 if needed.' }
        ],
        102: [
          { name: 'Charlie', createdAt: iso(40), content: 'Also consider rotating tokens when session changes.' }
        ]
      };

      return { question, answers, commentsByAnswer };
    })();

    const renderComments = async (answerId, commentsContainer) => {
      const comments = mock.commentsByAnswer[answerId] || [];
      if (comments.length === 0) {
        commentsContainer.innerHTML = '<small class="threads-time">No comments yet.</small>';
        return;
      }
      comments.forEach(comment => {
        const commentElement = document.createElement('div');
        commentElement.className = 'threads-comment';
        commentElement.innerHTML = `
          <div class="threads-line threads-line-subtle"></div>
          <div class="d-flex align-items-start">
            ${createAvatar(comment.name, 'sm').outerHTML}
            <div>
              <div>
                <strong class="threads-author-sm">${comment.name}</strong>
                <small class="threads-time ms-2">${formatDate(comment.createdAt)}</small>
              </div>
              <p class="threads-comment-content">${comment.content}</p>
            </div>
          </div>
        `;
        commentsContainer.appendChild(commentElement);
      });
    };

    const renderAnswers = async (questionId) => {
      const answers = mock.answers;
      document.getElementById('answers-heading').textContent = `Answers (${answers.length})`;

      answersContainer.innerHTML = '';
      if (answers.length === 0) {
        answersContainer.innerHTML = '<p class="threads-time">No answers yet.</p>';
        return;
      }

      for (const answer of answers) {
        const answerElement = document.createElement('div');
        answerElement.className = 'threads-post threads-answer';
        answerElement.innerHTML = `
          <div class="threads-line"></div>
          <div class="d-flex align-items-start">
            ${createAvatar(answer.userName, 'md').outerHTML}
            <div class="flex-grow-1">
              <div class="mb-2">
                <strong class="threads-author">${answer.userName}</strong>
                <small class="threads-time ms-2">${formatDate(answer.createdAt)}</small>
              </div>
              <div id="answerCollapse${answer.id}">
                <p class="threads-content">${answer.content}</p>
                <div class="comments-container" id="comments-for-answer-${answer.id}"></div>
                ${currentUser ? `
                <form class="comment-form mt-2" data-answer-id="${answer.id}">
                  <div class="input-group">
                    <input type="text" class="threads-input" placeholder="Add a comment..." required>
                    <button class="threads-btn-ghost btn-sm" type="submit">Post</button>
                  </div>
                </form>
                ` : ''}
              </div>
            </div>
          </div>
        `;
        answersContainer.appendChild(answerElement);
        const commentsContainer = document.getElementById(`comments-for-answer-${answer.id}`);
        await renderComments(answer.id, commentsContainer);
      }

      document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', handleCommentSubmit);
      });
    };

    const renderQuestion = async (questionId) => {
      const question = mock.question;
      questionContainer.innerHTML = `
        <div class="threads-post threads-question">
          <div class="d-flex align-items-start">
            ${createAvatar(question.writerNickname, 'lg').outerHTML}
            <div class="flex-grow-1">
              <h2 class="threads-question-title">${question.title}</h2>
              <div class="mb-2">
                <strong class="threads-author">${question.writerNickname}</strong>
                <small class="threads-time ms-2">${formatDate(question.createdAt)}</small>
              </div>
              <p class="threads-content mt-3">${question.content}</p>
              <div class="threads-tags mt-3">
                ${question.tags.map(tag => `<span class="threads-tag">${tag}</span>`).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      await renderAnswers(questionId);
    };

    const handleCommentSubmit = async (e) => {
      e.preventDefault();
      const form = e.target;
      const answerId = Number(form.dataset.answerId);
      const input = form.querySelector('input');
      const content = input.value.trim();
      if (!content) return;

      const newComment = { name: currentUser.name, createdAt: new Date().toISOString(), content };
      const list = mock.commentsByAnswer[answerId] || [];
      list.push(newComment);
      mock.commentsByAnswer[answerId] = list;

      input.value = '';
      await renderAnswers(mock.question.id);
    };

    const handleAnswerSubmit = async (e) => {
      e.preventDefault();
      const content = answerContentInput.value.trim();
      if (!content) return;

      const newAnswer = {
        id: Math.floor(Math.random() * 100000) + 1000,
        userName: currentUser.name,
        createdAt: new Date().toISOString(),
        content
      };
      mock.answers.unshift(newAnswer);
      answerContentInput.value = '';
      await renderAnswers(mock.question.id);
    };

    const setLoggedInUI = () => {
      userActions.innerHTML = `
        <span class="threads-author me-2">Welcome, ${currentUser.name}</span>
        <button type="button" class="threads-btn-secondary" id="logout-button">Logout</button>
      `;
      document.getElementById('logout-button').addEventListener('click', () => {
        currentUser = null;
        setLoggedOutUI();
        renderQuestion(mock.question.id);
      });
      answerFormCard.style.display = 'block';
    };

    const setLoggedOutUI = () => {
      userActions.innerHTML = `
        <a href="#" class="threads-btn-primary" onclick="loginDemo(); return false;">Login</a>
        <a href="#" class="threads-btn-secondary" onclick="return false;">Register</a>
      `;
      answerFormCard.style.display = 'none';
    };

    const mountThemeToggle = () => {
      const container = document.getElementById('theme-toggle-container');
      container.innerHTML = `<button id="theme-toggle" class="threads-btn-ghost btn-sm" type="button">Toggle theme</button>`;
      container.querySelector('#theme-toggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        document.body.classList.toggle('dark');
      });
    };

    window.loginDemo = () => {
      currentUser = { id: 1, name: 'SeungHyun' };
      setLoggedInUI();
      renderQuestion(mock.question.id);
    };

    const initializeApp = async () => {
      mountThemeToggle();
      setLoggedOutUI();
      await renderQuestion(mock.question.id);
      answerForm.addEventListener('submit', handleAnswerSubmit);
    };

    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
